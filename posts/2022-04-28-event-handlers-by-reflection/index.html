<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Mike Hadlow C# .NET technical blog."><meta name=author content="Mike Hadlow"><meta property="og:url" content="https://mikehadlow.com/posts/2022-04-28-event-handlers-by-reflection/"><meta property="og:type" content="article"><meta property="og:title" content="C#: Add event handlers dynamically using reflection"><meta property="og:description" content="Recently I had a situation where I needed to test a class with dozens of event handlers. Rather than manually write the repetitive code to attach the handlers I decided to cheat and use reflection. Since there wasn&rsquo;t anything immediately available online that I could find, I&rsquo;m sharing an example here to show how to do it."><meta property="og:image" content="https://mikehadlow.com/img/blog-image.png"><title>Mike Hadlow</title>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css><link rel=icon href=/favicon.svg type=image/svg+xml></head><body><nav class="navbar is-dark" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a href=/ class=navbar-item><strong>Mike Hadlow</strong>
</a><a role=button class=navbar-burger aria-label=menu aria-expanded=false data-target=menu><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a></div><div id=menu class=navbar-menu><div class=navbar-start><a href=https://mikehadlow.com/top/about/ class=navbar-item>About</a>
<a href=https://mikehadlow.com/top/contact/ class=navbar-item>Contact</a>
<a href=https://bsky.app/profile/mikehadlow.com target=_blank rel="noopener noreferrer" class=navbar-item><svg height="24" viewBox="0 0 64 64" width="24" aria-hidden="true"><path fill="#0085ff" d="M13.873 3.805C21.21 9.332 29.103 20.537 32 26.55v15.882c0-.338-.13.044-.41.867-1.512 4.456-7.418 21.847-20.923 7.944-7.111-7.32-3.819-14.64 9.125-16.85-7.405 1.264-15.73-.825-18.014-9.015C1.12 23.022.0 8.51.0 6.55.0-3.268 8.579-.182 13.873 3.805zm36.254.0C42.79 9.332 34.897 20.537 32 26.55v15.882c0-.338.13.044.41.867 1.512 4.456 7.418 21.847 20.923 7.944 7.111-7.32 3.819-14.64-9.125-16.85 7.405 1.264 15.73-.825 18.014-9.015C62.88 23.022 64 8.51 64 6.55c0-9.818-8.578-6.732-13.873-2.745z"/></svg>
</a><a href=https://github.com/mikehadlow target=_blank rel="noopener noreferrer" class=navbar-item><svg height="24" viewBox="0 0 16 16" width="24" aria-hidden="true"><path style="fill:#fff" fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-two-thirds"><h1 class=title>C#: Add event handlers dynamically using reflection</h1><p class=subtitle>By Mike Hadlow, published Apr 28, 2022</p><div><article id=content class=content><p>Recently I had a situation where I needed to test a class with dozens of event handlers. Rather than manually write the repetitive code to attach the handlers I decided to cheat and use reflection. Since there wasn&rsquo;t anything immediately available online that I could find, I&rsquo;m sharing an example here to show how to do it.</p><p>The code below is a simple console application that demonstrates this technique. There is a class <code>ThingWithEvents</code> that exports a couple of events, <code>OnSayHello</code> and <code>OnCounter</code>. The program creates an instance of this class then calls <code>SubscribeToEvents</code>. This reflects over all the events in the given type and for each event calls <code>GetHandlerFor</code> which generates an <code>EventHandler&lt;T></code> delegate of the correct type.</p><p>There&rsquo;s a <a href=https://gist.github.com/mikehadlow/3d7fdc986ef913c1d689dcbdecd7ae70>GitHub Gist here</a> for any suggestions or comments.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#66d9ef>namespace</span> EventHandlersByReflection;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Reflection;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> static System.Console;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Program</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> Main()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> thing = <span style=color:#66d9ef>new</span> ThingWithEvents();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        SubscribeToEvents(thing);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        thing.SayHello(<span style=color:#e6db74>&#34;Hello World!&#34;</span>);
</span></span><span style=display:flex><span>        thing.Count();
</span></span><span style=display:flex><span>        thing.Count();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> SubscribeToEvents&lt;T&gt;(T target)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>foreach</span>(<span style=color:#66d9ef>var</span> @event <span style=color:#66d9ef>in</span> target.GetType().GetEvents())
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> handler = GetHandlerFor(@event);
</span></span><span style=display:flex><span>            @event.AddEventHandler(target, handler);
</span></span><span style=display:flex><span>            WriteLine(<span style=color:#e6db74>$&#34;Subscribed to {@event.Name}&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> MethodInfo? genericHandlerMethod = <span style=color:#66d9ef>typeof</span>(Program).GetMethod(<span style=color:#e6db74>&#34;Handler&#34;</span>, BindingFlags.Static | BindingFlags.NonPublic);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Delegate GetHandlerFor(EventInfo eventInfo)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> eventArgsType = eventInfo.EventHandlerType?.GetMethod(<span style=color:#e6db74>&#34;Invoke&#34;</span>)?.GetParameters()[<span style=color:#ae81ff>1</span>]?.ParameterType;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(eventArgsType <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ApplicationException(<span style=color:#e6db74>&#34;Couldn&#39;t get event args type from eventInfo.&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> handlerMethod = genericHandlerMethod?.MakeGenericMethod(eventArgsType);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(handlerMethod <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ApplicationException(<span style=color:#e6db74>&#34;Couldn&#39;t get handlerMethod from genericHandlerMethod.&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Delegate.CreateDelegate(<span style=color:#66d9ef>typeof</span>(EventHandler&lt;&gt;).MakeGenericType(eventArgsType), handlerMethod);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// zero refernces, but accessed via reflection. Do not delete!</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> Handler&lt;TArgs&gt;(<span style=color:#66d9ef>object?</span> sender, TArgs args)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(args <span style=color:#66d9ef>is</span> SayHelloEventArgs sayHelloEventArgs)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            WriteLine(<span style=color:#e6db74>$&#34;SayHello said: {sayHelloEventArgs.Messsage}&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(args <span style=color:#66d9ef>is</span> CounterEventArgs counterEventArgs)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            WriteLine(<span style=color:#e6db74>$&#34;Counter is {counterEventArgs.Counter}&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ThingWithEvents</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> counter = <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> SayHello(<span style=color:#66d9ef>string</span> message)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        OnSayHello(<span style=color:#66d9ef>this</span>, <span style=color:#66d9ef>new</span> SayHelloEventArgs { Messsage = message });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Count()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        OnCounter(<span style=color:#66d9ef>this</span>, <span style=color:#66d9ef>new</span> CounterEventArgs { Counter = counter });
</span></span><span style=display:flex><span>        counter++;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>event</span> EventHandler&lt;SayHelloEventArgs&gt; OnSayHello;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>event</span> EventHandler&lt;CounterEventArgs&gt; OnCounter;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SayHelloEventArgs</span> : EventArgs
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> Messsage { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; } = <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CounterEventArgs</span> : EventArgs
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> Counter { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; } = <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></article></div></div><div class="column is-one-third box"><div class=content><p><strong>Hi, I&rsquo;m Mike Hadlow. Software Engineer, based in Sussex, UK.</strong></p><p>Find my old blog at <a href=http://mikehadlow.blogspot.com/>Code Rant</a>. This ran from 2005 to 2020 and has hundreds of posts.</p><p><em>All code on this blog is published under an <a href=https://opensource.org/licenses/MIT>MIT licence</a>. You are free to copy it and use it for any purpose without attribution. There is no warranty whatsoever. All non-code text is copyright Mike Hadlow and cannot be reused without permission.</em></p><p><strong>There are no cookies on this site</strong></p><p>The GitHub repository for this site is <a href=https://github.com/mikehadlow/mikehadlow.github.io>here</a>.</p></div></div></div></div></section></body><script>document.addEventListener("DOMContentLoaded",()=>{const e=Array.prototype.slice.call(document.querySelectorAll(".navbar-burger"),0);e.length>0&&e.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.target,n=document.getElementById(t);e.classList.toggle("is-active"),n.classList.toggle("is-active")})})})</script></html>